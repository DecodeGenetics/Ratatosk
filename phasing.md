# Phasing

Ratatosk takes phasing files as optional arguments. Phasing files indicate for each input read (short and long) to which haploblock and haplotype the read belongs (or if the read is unphased).

## Requirements

* [WhatsHap](https://whatshap.readthedocs.io/en/latest/)

## Input

The following files are required to phase:

* Long read mapping (BAM file)
* Short read mapping (BAM file)
* Genotyped small variants from the short reads (VCF file)

We recommend [bwa-mem](https://github.com/lh3/bwa) to map the short reads and [winnowmap2](https://github.com/marbl/Winnowmap) for the long reads. Input BAM files must be sorted and indexed (`samtools sort` and `samtools index`). To discover and genotype small variants, we recommend [GraphTyper2](https://github.com/DecodeGenetics/graphtyper) or [DeepVariant](https://github.com/google/deepvariant).

We assume in the following that a single sample is being phased (all reads come from the same individual and the VCF file is not multi-sample).

## Usage

* Long read mapping: *long.bam*
* Short read mapping: *short.bam*
* Genotyped small variants from the short reads: *short.vcf.gz*
* Reference genome: *ref.fa*

1. **VCF phasing**
```
whatshap phase --reference ref.fa --output short.phased.vcf.gz --ignore-read-groups short.vcf.gz long.bam; tabix -p vcf short.phased.vcf.gz
tabix -p vcf short.phased.vcf.gz
```
This command uses the long reads to phase the variants discovered/genotyped from the short reads.

2. **Short reads haplotagging**
```
whatshap haplotag --reference ref.fa --output short.haplotag.bam --output-haplotag-list short.haplotag.tsv.gz --ignore-read-groups short.phased.vcf.gz short.bam
```
This command generates a new BAM file for the short reads in which reads are tagged by haplogroup and haplotype (using the phased variants). The file that Ratatosk needs is *short.haplotag.tsv.gz*: it is a tabulated (compressed) file indicating for each short read name to which haplogroup and haplotype the read corresponds.

3. **Long reads haplotagging**
```
whatshap haplotag --reference ref.fa --output long.haplotag.bam --output-haplotag-list long.haplotag.tsv.gz --ignore-read-groups short.phased.vcf.gz short.bam
```
This command generates a new BAM file for the long reads in which reads are tagged by haplogroup and haplotype (using the phased variants). The file that Ratatosk needs is *long.haplotag.tsv.gz*: it is a tabulated (compressed) file indicating for each long read name to which haplogroup and haplotype the read corresponds.

4. **After phasing**

* BAM files generated by the `whatshap haplotag` commands are not used by Ratatosk and can be removed.
* When using the Ratatosk binary or the reference-guided scripts, add `-p short.haplotag.tsv.gz -P long.haplotag.tsv.gz` to your command to use the phasing files. Note that **both** short and long reads **must** be phased to use the phasing.
